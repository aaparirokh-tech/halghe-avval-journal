<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ú˜ÙˆØ±Ù†Ø§Ù„ Ø­Ù„Ù‚Ù‡ Ø§ÙˆÙ„ ÙØ§Ø±Ú©Ø³ | ØªØ±ÛŒØ¯ÛŒÙ†Ú¯ Ø±Ø¨Ø§Øª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(255,215,0,0.1);
            border: 2px solid #ffd700;
            border-radius: 20px;
        }
        
        .logo {
            font-size: 40px;
            margin-bottom: 10px;
        }
        
        h1 {
            color: #ffd700;
            font-size: 22px;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #00d4ff;
            font-size: 14px;
        }
        
        .group-name {
            color: #888;
            font-size: 12px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        /* ØµÙØ­Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ */
        .permission-screen {
            background: rgba(0,0,0,0.5);
            border: 2px solid #00d4ff;
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            margin: 30px 0;
        }
        
        .permission-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .permission-title {
            color: #ffd700;
            font-size: 20px;
            margin-bottom: 15px;
        }
        
        .permission-text {
            color: #ccc;
            font-size: 14px;
            line-height: 2;
            margin-bottom: 25px;
        }
        
        .permission-btn {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: white;
            border: none;
            padding: 18px 40px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 20px rgba(0,212,255,0.3);
        }
        
        .permission-btn:active {
            transform: scale(0.98);
        }
        
        .permission-denied {
            background: rgba(255,71,87,0.2);
            border: 2px solid #ff4757;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            display: none;
        }
        
        .date-box {
            background: rgba(255,215,0,0.15);
            border: 1px solid #ffd700;
            padding: 15px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .date-box h2 {
            color: #ffd700;
            font-size: 18px;
        }
        
        .voice-btn {
            width: 100%;
            padding: 20px;
            border: none;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .start-btn {
            background: linear-gradient(135deg, #ffd700, #ffaa00);
            color: #0f0c29;
            box-shadow: 0 5px 20px rgba(255,215,0,0.3);
        }
        
        .start-btn:active {
            transform: scale(0.98);
        }
        
        .recording-btn {
            background: linear-gradient(135deg, #ff4757, #cc0033);
            color: white;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255,71,87,0.7); }
            50% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(255,71,87,0); }
        }
        
        .question-box {
            background: rgba(0,212,255,0.1);
            border: 2px solid #00d4ff;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            text-align: center;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        .question-number {
            color: #ffd700;
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .question-text {
            font-size: 18px;
            line-height: 1.7;
            color: white;
        }
        
        .status {
            text-align: center;
            color: #00d4ff;
            font-size: 14px;
            margin-bottom: 20px;
            min-height: 25px;
            font-weight: bold;
        }
        
        .answer-box {
            background: rgba(255,215,0,0.1);
            border-right: 4px solid #ffd700;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 15px;
            display: none;
        }
        
        .answer-box.show {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .answer-label {
            color: #ffd700;
            font-size: 12px;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        .answer-text {
            color: white;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .result-box {
            background: linear-gradient(135deg, rgba(255,215,0,0.15), rgba(0,212,255,0.15));
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 25px;
            margin-top: 20px;
            display: none;
        }
        
        .result-box.show {
            display: block;
            animation: fadeIn 0.5s;
        }
        
        .result-title {
            color: #ffd700;
            font-size: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .section-title {
            color: #00d4ff;
            font-size: 16px;
            margin: 15px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(0,212,255,0.3);
        }
        
        .strength {
            background: rgba(0,255,136,0.15);
            border-right: 4px solid #00ff88;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        
        .weakness {
            background: rgba(255,71,87,0.15);
            border-right: 4px solid #ff4757;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        
        .warning-item {
            background: rgba(255,215,0,0.15);
            border-right: 4px solid #ffd700;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 10px;
        }
        
        .mentor-box {
            background: rgba(0,212,255,0.2);
            border: 2px solid #00d4ff;
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }
        
        .mentor-title {
            color: #00d4ff;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .save-btn {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: #0f0c29;
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .history-btn {
            background: rgba(255,215,0,0.2);
            color: #ffd700;
            width: 100%;
            padding: 15px;
            border: 2px solid #ffd700;
            border-radius: 15px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
        }
        
        .progress-bar {
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #00d4ff);
            border-radius: 3px;
            transition: width 0.5s ease;
            width: 0%;
        }
        
        .icon {
            font-size: 28px;
        }
        
        .hidden {
            display: none !important;
        }
        
        .browser-hint {
            background: rgba(255,215,0,0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            font-size: 12px;
            color: #ccc;
        }
        
        .browser-hint strong {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ğŸ¤–</div>
            <h1>Ú˜ÙˆØ±Ù†Ø§Ù„ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ</h1>
            <div class="subtitle">Ø­Ù„Ù‚Ù‡ Ø§ÙˆÙ„ ÙØ§Ø±Ú©Ø³</div>
            <div class="group-name">Ù…Ø¬Ù…ÙˆØ¹Ù‡ ØªØ±ÛŒØ¯ÛŒÙ†Ú¯ Ø±Ø¨Ø§Øª</div>
        </div>
        
        <!-- ØµÙØ­Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ -->
        <div class="permission-screen" id="permissionScreen">
            <div class="permission-icon">ğŸ™ï¸</div>
            <h2 class="permission-title">Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙ†</h2>
            <p class="permission-text">
                Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¯Ø³ØªÛŒØ§Ø± ØµÙˆØªÛŒ Ú˜ÙˆØ±Ù†Ø§Ù„ØŒ<br>
                Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ø¯Ø§Ø±ÛŒÙ….<br><br>
                âœ… ØµØ­Ø¨Øª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØŒ ØªØ§ÛŒÙ¾ Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒ<br>
                âœ… Ø³ÙˆØ§Ù„Ø§Øª ØµÙˆØªÛŒ Ù¾Ø±Ø³ÛŒØ¯Ù‡ Ù…ÛŒâ€ŒØ´Ù‡<br>
                âœ… Ø¬ÙˆØ§Ø¨Ø§Øª Ø¶Ø¨Ø· Ùˆ ØªØ­Ù„ÛŒÙ„ Ù…ÛŒâ€ŒØ´Ù‡
            </p>
            <button class="permission-btn" onclick="requestMicrophone()">
                <span>ğŸš€</span>
                <span>Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø¯Ù‡</span>
            </button>
            
            <div class="permission-denied" id="permissionDenied">
                <p style="color: #ff4757; margin-bottom: 10px;">âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯</p>
                <p style="font-size: 13px; color: #ccc;">
                    Ù„Ø·ÙØ§Ù‹ Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø±Ùˆ Ùˆ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ø±Ùˆ ÙØ¹Ø§Ù„ Ú©Ù†.<br>
                    ÛŒØ§ ØµÙØ­Ù‡ Ø±Ùˆ Ø±ÛŒÙØ±Ø´ Ú©Ù† Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.
                </p>
            </div>
            
            <div class="browser-hint">
                <strong>ğŸ’¡ Ø±Ø§Ù‡Ù†Ù…Ø§:</strong><br>
                Chrome: Ø±ÙˆÛŒ ğŸ”’ Ú©Ù†Ø§Ø± Ø¢Ø¯Ø±Ø³ Ú©Ù„ÛŒÚ© Ú©Ù† â†’ Site settings â†’ Microphone â†’ Allow<br>
                Safari: Preferences â†’ Websites â†’ Microphone â†’ Allow
            </div>
        </div>
        
        <!-- ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ú˜ÙˆØ±Ù†Ø§Ù„ (Ù…Ø®ÙÛŒ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§) -->
        <div id="mainApp" class="hidden">
            <div class="date-box">
                <h2 id="currentDate">Ø§Ù…Ø±ÙˆØ²</h2>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar"></div>
            </div>
            
            <button class="voice-btn start-btn" id="startBtn" onclick="startJournal()">
                <span class="icon">ğŸ™ï¸</span>
                <span>Ø´Ø±ÙˆØ¹ Ú˜ÙˆØ±Ù†Ø§Ù„ ØµÙˆØªÛŒ</span>
            </button>
            
            <div class="question-box hidden" id="questionBox">
                <div class="question-number" id="questionNumber">Ø³ÙˆØ§Ù„ Û± Ø§Ø² Û¸</div>
                <p class="question-text" id="questionText">Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ§ÛŒØŸ</p>
            </div>
            
            <p class="status" id="status"></p>
            
            <div id="answersContainer"></div>
            
            <div class="result-box" id="resultBox">
                <h3 class="result-title">ğŸ¯ ØªØ­Ù„ÛŒÙ„ Ø±ÙˆØ²Ø§Ù†Ù‡</h3>
                
                <div class="section-title">ğŸ’ª Ù†Ù‚Ø§Ø· Ù‚ÙˆØª:</div>
                <div id="strengthsList"></div>
                
                <div class="section-title">âš ï¸ Ù†Ù‚Ø§Ø· Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯:</div>
                <div id="weaknessesList"></div>
                
                <div class="section-title">ğŸ“ ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ:</div>
                <div id="suggestionsList"></div>
                
                <div class="mentor-box" id="mentorBox">
                    <div class="mentor-title">ğŸ‘¨â€ğŸ« Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø¨Ø§ Ù…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒØŸ</div>
                    <p id="mentorText" style="color: white; font-size: 14px;"></p>
                </div>
            </div>
            
            <button class="save-btn hidden" id="saveBtn" onclick="saveJournal()">
                ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ú˜ÙˆØ±Ù†Ø§Ù„ Ø±ÙˆØ²Ø§Ù†Ù‡
            </button>
            
            <button class="history-btn" id="historyBtn" onclick="toggleHistory()">
                ğŸ“š ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú˜ÙˆØ±Ù†Ø§Ù„â€ŒÙ‡Ø§
            </button>
            
            <div id="historyContainer" style="display: none; margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        // Ø³ÙˆØ§Ù„Ø§Øª Ø§Ø®ØªØµØ§ØµÛŒ Ú¯Ø±ÙˆÙ‡ Ø­Ù„Ù‚Ù‡ Ø§ÙˆÙ„ ÙØ§Ø±Ú©Ø³
        const questions = [
            {
                q: "Ø³Ù„Ø§Ù… ØªØ±ÛŒØ¯Ø± Ø¹Ø²ÛŒØ²! Ø§Ø² Ù„Ø­Ø§Ø¸ Ø±ÙˆØ­ÛŒ Ùˆ Ø±ÙˆØ§Ù†ÛŒ Ø§Ù…Ø±ÙˆØ² Ø®ÙˆØ¨ Ø¨ÙˆØ¯ÛŒØŸ Ø­Ø§Ù„Øª Ú†Ø·ÙˆØ± Ø¨ÙˆØ¯ØŸ",
                key: "mental_state",
                type: "mental"
            },
            {
                q: "Ø¢ÛŒØ§ Ø§Ø² Ø±Ø¨Ø§Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ ÛŒØ§ Ø§Ø¹Ø¯Ø§Ø¯ Ø·Ù„Ø§ÛŒÛŒ Ùˆ Ù„ÛŒÙ…ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯ÛŒØŸ",
                key: "tools_usage",
                type: "tools"
            },
            {
                q: "Ø³ØªØ§Ù¾ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ Ù…Ø´Ø®Øµ Ùˆ ÙˆØ§Ø¶Ø­ Ø¨Ø±Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù…Ø¹Ø§Ù…Ù„Ù‡ ØªØ´Ú©ÛŒÙ„ Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŸ",
                key: "setup_formed",
                type: "setup"
            },
            {
                q: "Ø§Ø³ØªØ§Ù¾ Ù„Ø§Ø³ Ùˆ ØªØ§Ø±Ú¯Øª Ù…Ø´Ø®Øµ Ø¨Ø±Ø§ÛŒ Ø³ØªØ§Ù¾ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒØª ØªØ¹ÛŒÛŒÙ† Ú©Ø±Ø¯Ù‡ Ø¨ÙˆØ¯ÛŒØŸ",
                key: "sl_tp_defined",
                type: "risk"
            },
            {
                q: "Ø§Ù…Ø±ÙˆØ² Ø³ÙˆØ¯ Ú©Ø±Ø¯ÛŒ ÛŒØ§ Ø¶Ø±Ø±ØŸ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¹Ù„Øª Ø³ÙˆØ¯ ÛŒØ§ Ø¶Ø±Ø± Ú©Ø±Ø¯Ù†Øª Ú†ÛŒ Ø¨ÙˆØ¯Ù‡ØŸ",
                key: "profit_loss_reason",
                type: "analysis"
            },
            {
                q: "Ø­Ø¯ Ø¶Ø±Ø± Ùˆ Ø­Ø¯ Ø³ÙˆØ¯ Ø±ÙˆØ²Ø§Ù†Ù‡ Ø±Ùˆ Ú©Ù‡ Ø¨Ø§ ØªÛŒÙ… Ù…Ø´Ø®Øµ Ú©Ø±Ø¯ÛŒÙ…ØŒ Ø±Ø¹Ø§ÛŒØª Ú©Ø±Ø¯ÛŒØŸ",
                key: "daily_limits",
                type: "discipline"
            },
            {
                q: "ÙÚ©Ø± Ù…ÛŒâ€ŒÚ©Ù†ÛŒ Ù„Ø§Ø²Ù… Ø¯Ø§Ø±ÛŒ Ø§Ø² Ù…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒØª Ù…Ø´Ø§ÙˆØ±Ù‡ Ø¨Ú¯ÛŒØ±ÛŒØŸ Ø¯Ø± Ú†Ù‡ Ù…ÙˆØ±Ø¯ÛŒØŸ",
                key: "mentor_need",
                type: "mentor"
            },
            {
                q: "Ù‡Ø± Ø³ÙˆØ§Ù„ ÛŒØ§ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ù…ÙˆØ±Ø¯ Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒØ§Øª Ø¯Ø§Ø±ÛŒ Ø¨Ú¯ÙˆØŒ ØªØ§ Ø¨Ø§ Ù…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒØª Ø¯Ø± Ù…ÛŒÙˆÙ† Ø¨Ø°Ø§Ø±Ù….",
                key: "questions_problems",
                type: "feedback"
            }
        ];
        
        let currentQuestion = 0;
        let answers = {};
        let recognition;
        let synthesis;
        let isRecording = false;
        let microphoneAllowed = false;
        
        // ØªÙ†Ø¸ÛŒÙ… ØªØ§Ø±ÛŒØ®
        const today = new Date();
        const dateStr = today.toLocaleDateString('fa-IR', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        document.getElementById('currentDate').textContent = dateStr;
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡
        loadHistory();
        
        // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙ†
        async function requestMicrophone() {
            try {
                // Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ù…Ø±ÙˆØ±Ú¯Ø±
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯
                microphoneAllowed = true;
                stream.getTracks().forEach(track => track.stop()); // Ù‚Ø·Ø¹ Ù…ÙˆÙ‚Øª
                
                // Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† ØµÙØ­Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø§Ù¾
                document.getElementById('permissionScreen').classList.add('hidden');
                document.getElementById('mainApp').classList.remove('hidden');
                
                // Ù¾ÛŒØ§Ù… Ø®ÙˆØ´â€ŒØ¢Ù…Ø¯
                speak('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯. Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø´Ø±ÙˆØ¹ Ú©Ù„ÛŒÚ© Ú©Ù†.');
                
            } catch (error) {
                console.error('Ø®Ø·Ø§:', error);
                document.getElementById('permissionDenied').style.display = 'block';
                
                if (error.name === 'NotAllowedError') {
                    alert('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ø±Ø¯ Ø´Ø¯.\n\nÙ„Ø·ÙØ§Ù‹:\n1. Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø±Ùˆ\n2. Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ø±Ùˆ ÙØ¹Ø§Ù„ Ú©Ù†\n3. ØµÙØ­Ù‡ Ø±Ùˆ Ø±ÛŒÙØ±Ø´ Ú©Ù†');
                } else if (error.name === 'NotFoundError') {
                    alert('âŒ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.\n\nÙ„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´Ùˆ Ù…ÛŒÚ©Ø±ÙˆÙÙ† ÙˆØµÙ„ Ù‡Ø³Øª.');
                }
            }
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø³ØªØ±Ø³ÛŒ (Ø¨Ø¹Ø¶ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§)
        function checkMicrophonePermission() {
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'microphone' }).then(result => {
                    if (result.state === 'granted') {
                        // Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡
                        document.getElementById('permissionScreen').classList.add('hidden');
                        document.getElementById('mainApp').classList.remove('hidden');
                        microphoneAllowed = true;
                    }
                });
            }
        }
        
        // Ø¨Ø±Ø±Ø³ÛŒ Ø¯Ø± Ø´Ø±ÙˆØ¹
        checkMicrophonePermission();
        
        function initSpeech() {
            if (!microphoneAllowed) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§ÙˆÙ„ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ø±Ùˆ Ø¨Ø¯Ù‡.');
                return false;
            }
            
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.lang = 'fa-IR';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    handleAnswer(transcript);
                };
                
                recognition.onerror = function(event) {
                    console.error('Ø®Ø·Ø§:', event.error);
                    document.getElementById('status').textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØ´Ø®ÛŒØµ. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ù…ÛŒâ€ŒÚ¯Ù…...';
                    stopRecording();
                    
                    // ØªÚ©Ø±Ø§Ø± Ø³ÙˆØ§Ù„
                    setTimeout(() => {
                        speak(questions[currentQuestion].q);
                        setTimeout(startRecording, 3000);
                    }, 2000);
                };
                
                recognition.onend = function() {
                    stopRecording();
                };
                
                return true;
            } else {
                alert('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯. Ø§Ø² Chrome ÛŒØ§ Safari Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.');
                return false;
            }
        }
        
        function speak(text) {
            if ('speechSynthesis' in window) {
                synthesis = window.speechSynthesis;
                synthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'fa-IR';
                utterance.rate = 0.85;
                utterance.pitch = 1;
                synthesis.speak(utterance);
            }
        }
        
        function startJournal() {
            if (!initSpeech()) return;
            
            currentQuestion = 0;
            answers = {};
            document.getElementById('answersContainer').innerHTML = '';
            document.getElementById('resultBox').classList.remove('show');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('startBtn').classList.add('hidden');
            document.getElementById('historyBtn').classList.add('hidden');
            document.getElementById('questionBox').classList.remove('hidden');
            
            askQuestion();
        }
        
        function askQuestion() {
            if (currentQuestion >= questions.length) {
                showResults();
                return;
            }
            
            const q = questions[currentQuestion];
            document.getElementById('questionNumber').textContent = `Ø³ÙˆØ§Ù„ ${currentQuestion + 1} Ø§Ø² ${questions.length}`;
            document.getElementById('questionText').textContent = q.q;
            
            speak(q.q);
            updateProgress();
            
            setTimeout(() => {
                startRecording();
            }, 3000);
        }
        
        async function startRecording() {
            if (!recognition) return;
            
            try {
                // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø³ØªØ±Ø³ÛŒ
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                
                isRecording = true;
                recognition.start();
                document.getElementById('status').textContent = 'ğŸ™ï¸ Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø·... ØµØ­Ø¨Øª Ú©Ù†';
                document.getElementById('questionBox').style.borderColor = '#ff4757';
                document.getElementById('questionBox').style.boxShadow = '0 0 20px rgba(255,71,87,0.3)';
                
            } catch (error) {
                document.getElementById('status').textContent = 'âŒ Ù…ÛŒÚ©Ø±ÙˆÙÙ† ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯. Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯Ù‡.';
                alert('Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙ† Ø±Ùˆ Ø¨Ø¯Ù‡.');
            }
        }
        
        function stopRecording() {
            isRecording = false;
            document.getElementById('status').textContent = '';
            document.getElementById('questionBox').style.borderColor = '#00d4ff';
            document.getElementById('questionBox').style.boxShadow = 'none';
        }
        
        function handleAnswer(text) {
            const q = questions[currentQuestion];
            answers[q.key] = text;
            
            const answerDiv = document.createElement('div');
            answerDiv.className = 'answer-box show';
            answerDiv.innerHTML = `
                <div class="answer-label">Ø³ÙˆØ§Ù„ ${currentQuestion + 1}: ${getQuestionTitle(q.key)}</div>
                <div class="answer-text">${text}</div>
            `;
            document.getElementById('answersContainer').appendChild(answerDiv);
            answerDiv.scrollIntoView({ behavior: 'smooth' });
            
            currentQuestion++;
            setTimeout(() => askQuestion(), 1500);
        }
        
        function getQuestionTitle(key) {
            const titles = {
                mental_state: 'ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ',
                tools_usage: 'Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§',
                setup_formed: 'Ø³ØªØ§Ù¾ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ',
                sl_tp_defined: 'Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©',
                profit_loss_reason: 'ØªØ­Ù„ÛŒÙ„ Ø³ÙˆØ¯/Ø¶Ø±Ø±',
                daily_limits: 'Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø±ÙˆØ²Ø§Ù†Ù‡',
                mentor_need: 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ù†ØªÙˆØ±',
                questions_problems: 'Ø³ÙˆØ§Ù„Ø§Øª Ùˆ Ù…Ø´Ú©Ù„Ø§Øª'
            };
            return titles[key] || key;
        }
        
        function updateProgress() {
            const progress = (currentQuestion / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
        }
        
        function showResults() {
            document.getElementById('progressBar').style.width = '100%';
            document.getElementById('questionBox').classList.add('hidden');
            
            // ØªØ­Ù„ÛŒÙ„ (Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ)
            const strengths = [];
            const weaknesses = [];
            const suggestions = [];
            let needMentor = false;
            let mentorReasons = [];
            
            if (answers.mental_state) {
                const text = answers.mental_state.toLowerCase();
                if (text.includes('Ø®ÙˆØ¨') || text.includes('Ø¹Ø§Ù„ÛŒ') || text.includes('Ø¢Ø±Ø§Ù…')) {
                    strengths.push('âœ“ ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ù…Ù†Ø§Ø³Ø¨ Ø¨Ø±Ø§ÛŒ Ù…Ø¹Ø§Ù…Ù„Ù‡â€ŒÚ¯Ø±ÛŒ');
                } else if (text.includes('Ø¨Ø¯') || text.includes('Ø§Ø³ØªØ±Ø³') || text.includes('Ø¹ØµØ¨ÛŒ')) {
                    weaknesses.push('âœ— ÙˆØ¶Ø¹ÛŒØª Ø±ÙˆØ­ÛŒ Ù†Ø§Ù…Ù†Ø§Ø³Ø¨');
                    suggestions.push('â€¢ Ù‚Ø¨Ù„ Ø§Ø² Ù…Ø¹Ø§Ù…Ù„Ù‡ Ù…Ø¯ÛŒØªÛŒØ´Ù† Ú©Ù†');
                    needMentor = true;
                    mentorReasons.push('Ú©Ù†ØªØ±Ù„ Ø§Ø³ØªØ±Ø³');
                }
            }
            
            if (answers.tools_usage) {
                const text = answers.tools_usage.toLowerCase();
                if (text.includes('Ø¨Ù„Ù‡') || text.includes('Ø¢Ø±Ù‡') || text.includes('Ø±Ø¨Ø§Øª')) {
                    strengths.push('âœ“ Ø§Ø³ØªÙØ§Ø¯Ù‡ ØµØ­ÛŒØ­ Ø§Ø² Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ ØªØ±ÛŒØ¯ÛŒÙ†Ú¯ Ø±Ø¨Ø§Øª');
                } else {
                    weaknesses.push('âœ— Ø¹Ø¯Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øªâ€ŒÙ‡Ø§');
                    suggestions.push('â€¢ Ø§Ø² Ø±Ø¨Ø§Øªâ€ŒÙ‡Ø§ Ùˆ Ù„ÛŒÙ…ÛŒØªâ€ŒÙ‡Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†');
                }
            }
            
            if (answers.setup_formed) {
                const text = answers.setup_formed.toLowerCase();
                if (text.includes('Ø¨Ù„Ù‡') || text.includes('Ø¨ÙˆØ¯')) {
                    strengths.push('âœ“ Ø±Ø¹Ø§ÛŒØª Ø§ØµÙˆÙ„ Ø³ØªØ§Ù¾ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ');
                } else {
                    weaknesses.push('âœ— ÙˆØ±ÙˆØ¯ Ø¨Ø¯ÙˆÙ† Ø³ØªØ§Ù¾ Ù…Ø´Ø®Øµ');
                    suggestions.push('â€¢ ÙÙ‚Ø· Ø¨Ø§ Ø³ØªØ§Ù¾ Ù…Ø´Ø®Øµ ÙˆØ§Ø±Ø¯ Ø´Ùˆ');
                    needMentor = true;
                    mentorReasons.push('Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø³ØªØ§Ù¾');
                }
            }
            
            if (answers.sl_tp_defined) {
                const text = answers.sl_tp_defined.toLowerCase();
                if (text.includes('Ø¨Ù„Ù‡') || text.includes('Ø¯Ø§Ø´ØªÙ…')) {
                    strengths.push('âœ“ Ø±Ø¹Ø§ÛŒØª Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©');
                } else {
                    weaknesses.push('âœ— Ø¹Ø¯Ù… ØªØ¹ÛŒÛŒÙ† SL/TP');
                    suggestions.push('â€¢ Ù‚Ø¨Ù„ Ø§Ø² ÙˆØ±ÙˆØ¯ SL Ùˆ TP Ù…Ø´Ø®Øµ Ú©Ù†');
                    needMentor = true;
                    mentorReasons.push('Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÛŒØ³Ú©');
                }
            }
            
            if (answers.daily_limits) {
                const text = answers.daily_limits.toLowerCase();
                if (text.includes('Ø¨Ù„Ù‡') || text.includes('Ø±Ø¹Ø§ÛŒØª')) {
                    strengths.push('âœ“ Ø±Ø¹Ø§ÛŒØª Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ ØªÛŒÙ…');
                } else {
                    weaknesses.push('âœ— Ø¹Ø¯Ù… Ø±Ø¹Ø§ÛŒØª Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§');
                    needMentor = true;
                    mentorReasons.push('Ø§Ù†Ø¶Ø¨Ø§Ø· ØªÛŒÙ…ÛŒ');
                }
            }
            
            if (answers.mentor_need) {
                const text = answers.mentor_need.toLowerCase();
                if (text.includes('Ø¨Ù„Ù‡') || text.includes('Ù„Ø§Ø²Ù…') || text.includes('Ù†ÛŒØ§Ø²')) {
                    needMentor = true;
                    mentorReasons.push(answers.mentor_need);
                }
            }
            
            document.getElementById('strengthsList').innerHTML = strengths.length > 0 
                ? strengths.map(s => `<div class="strength">${s}</div>`).join('')
                : '<div class="strength">â€¢ Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...</div>';
            
            document.getElementById('weaknessesList').innerHTML = weaknesses.length > 0
                ? weaknesses.map(w => `<div class="weakness">${w}</div>`).join('')
                : '<div class="strength">â€¢ Ø¹Ø§Ù„ÛŒ! Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù Ø®Ø§ØµÛŒ Ù†ÛŒØ³Øª</div>';
            
            document.getElementById('suggestionsList').innerHTML = suggestions.length > 0
                ? suggestions.map(s => `<div class="warning-item">${s}</div>`).join('')
                : '<div class="strength">â€¢ Ø±ÙˆÙ†Ø¯ Ø¹Ø§Ù„ÛŒ!</div>';
            
            const mentorText = needMentor 
                ? `âœ… Ø¨Ù„Ù‡ØŒ Ø¨Ø§ Ù…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±.\n\nğŸ“‹ Ù…ÙˆØ§Ø±Ø¯:\n${mentorReasons.map(r => 'â€¢ ' + r).join('\n')}`
                : 'âœ“ ÙØ¹Ù„Ø§Ù‹ Ù†ÛŒØ§Ø²ÛŒ Ù†ÛŒØ³ØªØŒ ÙˆÙ„ÛŒ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù‡Ø³ØªÛŒÙ….';
            
            document.getElementById('mentorText').textContent = mentorText;
            
            document.getElementById('resultBox').classList.add('show');
            document.getElementById('saveBtn').classList.remove('hidden');
            document.getElementById('historyBtn').classList.remove('hidden');
            
            const summary = `ØªØ­Ù„ÛŒÙ„ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯. ${strengths.length} Ù†Ù‚Ø·Ù‡ Ù‚ÙˆØª Ùˆ ${weaknesses.length} Ù†Ù‚Ø·Ù‡ Ø¶Ø¹Ù. ${needMentor ? 'Ù†ÛŒØ§Ø² Ø¨Ù‡ Ù…Ø´Ø§ÙˆØ±Ù‡ Ø¯Ø§Ø±ÛŒ.' : 'Ø¢ÙØ±ÛŒÙ†!'}`;
            speak(summary);
        }
        
        function saveJournal() {
            const journal = {
                date: dateStr,
                timestamp: new Date().toISOString(),
                answers: answers
            };
            
            let history = JSON.parse(localStorage.getItem('halgheAvvalJournals') || '[]');
            history.unshift(journal);
            if (history.length > 30) history = history.slice(0, 30);
            
            localStorage.setItem('halgheAvvalJournals', JSON.stringify(history));
            
            alert('âœ… Ú˜ÙˆØ±Ù†Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!\n\nÙ…Ù†ØªÙˆØ± Ø´Ø®ØµÛŒ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.');
            
            // Ø±ÛŒØ³Øª
            document.getElementById('startBtn').classList.remove('hidden');
            document.getElementById('startBtn').innerHTML = '<span class="icon">ğŸ”„</span><span>Ú˜ÙˆØ±Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯</span>';
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('questionBox').classList.add('hidden');
            document.getElementById('answersContainer').innerHTML = '';
            document.getElementById('progressBar').style.width = '0%';
            
            loadHistory();
        }
        
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('halgheAvvalJournals') || '[]');
            const container = document.getElementById('historyContainer');
            
            if (history.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #888; padding: 20px;">Ù‡Ù†ÙˆØ² Ú˜ÙˆØ±Ù†Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</p>';
                return;
            }
            
            container.innerHTML = history.map(j => `
                <div style="background: rgba(255,215,0,0.1); border: 1px solid #ffd700; border-radius: 15px; padding: 15px; margin-bottom: 15px;">
                    <div style="color: #ffd700; font-weight: bold; margin-bottom: 10px;">ğŸ“… ${j.date}</div>
                    <div style="font-size: 13px; color: #ccc;">ÙˆØ¶Ø¹ÛŒØª: ${j.answers.mental_state?.substring(0, 25) || '-'}...</div>
                </div>
            `).join('');
        }
        
        function toggleHistory() {
            const container = document.getElementById('historyContainer');
            container.style.display = container.style.display === 'none' ? 'block' : 'none';
        }
    </script>
</body>
</html>